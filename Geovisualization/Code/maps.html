<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">
  <title>Geovisualization Map</title>
  <!-- leaflet link-->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"/>
  <!-- Bootstrap core CSS-->
  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <!-- Custom fonts for this template-->
  <link href="vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
  <!-- Page level plugin CSS-->
  <link href="vendor/datatables/dataTables.bootstrap4.css" rel="stylesheet">
  <!-- Custom styles for this template-->
  <link href="css/sb-admin.css" rel="stylesheet">
  <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/1.3.4/chroma.min.js"></script>
  <script src='https://api.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.js'></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.css' rel='stylesheet' />
  <style type="text/css">


    #map1 {
      height: 500px;
      width: 1286px;
    }
	
	.legend {
    line-height: 16px;
    width: 140px;
    color: #333333;
    font-family: 'Open Sans', Helvetica, sans-serif;
    padding: 6px 8px;
    background: white;
    background: rgba(255,255,255,0.5);
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    border-radius: 5px;
	
}

.legend i {
    width: 16px;
    height: 16px;
    float: left;
    margin-right: 8px;
    opacity: 0.9;
}

.legend img {
    width: 16px;
    height: 16px;
    margin-right: 3px;
    float: left;
}

.legend p {
    font-size: 12px;
    line-height: 16px;
    margin: 0;
}
  </style>
</head>

<body class="fixed-nav sticky-footer bg-dark" id="page-top">
  <!-- Navigation-->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top" id="mainNav">
    <a class="navbar-brand" href="index.html">Geovisualization Map</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav navbar-sidenav" id="exampleAccordion">

        <li class="nav-item" data-toggle="tooltip" data-placement="right" title="Charts">
          <a class="nav-link" href="index.html">
            <i class="fa fa-fw fa-area-chart"></i>
            <span class="nav-link-text">Charts</span>
          </a>
        </li>

      </ul>
      <ul class="navbar-nav sidenav-toggler">
        <li class="nav-item">
          <a class="nav-link text-center" id="sidenavToggler">
            <i class="fa fa-fw fa-angle-left"></i>
          </a>
        </li>
      </ul>

    </div>
  </nav>

  <div class="content-wrapper">
    <div class="container-fluid">
      <!-- Breadcrumbs-->
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <a href="#">Dashboard</a>
        </li>
        <li class="breadcrumb-item active">Maps</li>
      </ol>
      <!-- Example DataTables Card-->
	   <div id="buttons">
		<button type="button" id="temperature_select">Temperature</button>
		<button type="button" id="humidity_select">Humidity</button>
		<button type="button" id="loadcell_select">Load Cell</button>
		<button type="button" id="battery_voltage_select">Battery Voltage</button>
		<!--<button type="button" id="elec_cond_select">Electric Conductivity</button>-->
	  </div>
      <div id="map_section">
        <div class="card-header">
          <i class="fa fa-table"></i> Web Map</div>
        <div id = 'map1'></div>
        <div class="card-footer small text-muted">Updated yesterday at 11:59 PM</div>
      </div>
    </div>
    <!-- /.container-fluid-->
    <!-- /.content-wrapper-->
    <footer class="sticky-footer">
      <div class="container">
        <div class="text-center">
          <small>Copyright © Your Website 2018</small>
        </div>
      </div>
    </footer>
    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
      <i class="fa fa-angle-up"></i>
    </a>
    <!-- Logout Modal-->
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5>
            <button class="close" type="button" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">×</span>
            </button>
          </div>
          <div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
          <div class="modal-footer">
            <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
            <a class="btn btn-primary" href="login.html">Logout</a>
          </div>
        </div>
      </div>
    </div>
    <!-- Bootstrap core JavaScript-->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <!-- Core plugin JavaScript-->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>
    <!-- Page level plugin JavaScript-->
    <script src="vendor/datatables/jquery.dataTables.js"></script>
    <script src="vendor/datatables/dataTables.bootstrap4.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>
    <!-- Custom scripts for all pages-->
    <script src="js/sb-admin.min.js"></script>
    <!-- Custom scripts for this page-->
    <script src="js/sb-admin-datatables.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>

  </div>

  <script>
var map = L.map('map1').setView([44.55, -123.216], 14);
var marker_color_list = ["Red", "Orange", "Yellow", "Green"];
var selection = "humidity"

document.getElementById("temperature_select").addEventListener("click", function(){select_var("temperature");});
document.getElementById("humidity_select").addEventListener("click", function(){select_var("humidity");});
document.getElementById("loadcell_select").addEventListener("click", function(){select_var("loadcell");});
document.getElementById("battery_voltage_select").addEventListener("click", function(){select_var("battery_voltage");});

function select_var(measurement){
	selection = measurement
	create_geoviz_map()
}

var legend = L.control({position: 'topright'});

function create_geoviz_map(){



			
		  console.log(selection);	
	
			
		  var Date_arr = ["dates"];	
          var Humidity = ["Humidity"];
          var TempC = ["Temperature(degrees Celsius)"];
		  var LoadCell = ["Load Cell"];
		  var BatteryVoltage = ["Battery Voltage"];
		//  var ElecCond = ["Electric Conductivity"];
		  
		  var Date_arr2 = ["dates"];
		  var Humidity2 = ["Humidity"];
		  var TempC2 = ["Temperature(degrees Celsius)"];
		  var LoadCell2 = ["Load Cell"];
		  var BatteryVoltage2 =  ["Battery Voltage"];
          // data streaming source connector
          var socket = io.connect('/');
	
          socket.on('join', function(data){
			
		  console.log(data);
			
          for(i = 0; i < data.length; i++) {
		  
		   var ds = data[i]['RTC_time'];
		  
		  if(data[i]['IDtag'] == "100"){
		  
			  var month = ds.substring(ds.indexOf("_") + 1, ds.indexOf("/"));
				
				var day = ds.substring(ds.indexOf("/") + 1);
				
				var hour = ds.substring(0, ds.indexOf(":"));
				
				var minute =  ds.substring(ds.indexOf(":") + 1, ds.indexOf("_"));
		
					
				var ts = new Date(2018,parseInt(month) - 1,parseInt(day),parseInt(hour),parseInt(minute));
			   
				Date_arr.push(ts);
		  
              var measuredHumidity = data[i]['humidity'];
              Humidity.push(measuredHumidity);
              var measuredTempC = data[i]['temp'];
              TempC.push(measuredTempC);
			  var measuredLoadCell = data[i]['loadCell'];
              LoadCell.push(measuredLoadCell);
			  var measuredBatteryVoltage = data[i]['vbat'];
              BatteryVoltage.push(measuredBatteryVoltage);
			  }
			else if(data[i]['IDtag'] == "200"){
			
			var month = ds.substring(ds.indexOf("_") + 1, ds.indexOf("/"));
				
				var day = ds.substring(ds.indexOf("/") + 1);
				
				var hour = ds.substring(0, ds.indexOf(":"));
				
				var minute =  ds.substring(ds.indexOf(":") + 1, ds.indexOf("_"));
		
					
				var ts = new Date(2018,parseInt(month) - 1,parseInt(day),parseInt(hour),parseInt(minute));
			   
				Date_arr2.push(ts);
			
			var measuredHumidity = data[i]['humidity'];
              Humidity2.push(measuredHumidity);
              var measuredTempC = data[i]['temp'];
              TempC2.push(measuredTempC);
			  var measuredLoadCell = data[i]['loadCell'];
              LoadCell2.push(measuredLoadCell);
			  var measuredBatteryVoltage = data[i]['vbat'];
              BatteryVoltage2.push(measuredBatteryVoltage);
			}
          }
		
	
		var temp_Humidity = Humidity;
		var temp_TempC = TempC;
		var temp_LoadCell = LoadCell;
		var temp_BatteryVoltage = BatteryVoltage;
		//var temp_ElecCond = ElecCond;
		
		var temp_Humidity2 = Humidity2;
		var temp_TempC2 = TempC2;
		var temp_LoadCell2 = LoadCell2;
		var temp_BatteryVoltage2 = BatteryVoltage2;

          L.tileLayer("https://api.mapbox.com/styles/v1/mapbox/outdoors-v9/tiles/256/{z}/{x}/{y}@2x?access_token=pk.eyJ1IjoianJvdGl0aG9yIiwiYSI6ImNqZG5wOXV4NjEwd2ozM280NGZ1Z3ZqM3YifQ.eSmbwYj_2WaWqgBCFOZxuA").addTo(map);
		 
		
		  
		  var marker_color = "blue";
		  var marker_color2 = "blue";
		  var select_list;
		  var select_list2;
		  var legend_buckets;
		    switch(selection){
		  case "temperature":
				select_list = temp_TempC;
				select_list2 = temp_TempC2;
				legend_buckets = [10,20,30];
				
				break;
		  case "humidity":
				select_list = temp_Humidity;
				select_list2 = temp_Humidity2;
				legend_buckets = [30,50,70];
				break;
		  case "loadcell":
				select_list = temp_LoadCell;
				select_list2 = temp_LoadCell2;
				legend_buckets = [-1,-.5,0];
				break;
		  case "battery_voltage":
				select_list = temp_BatteryVoltage;
				select_list2 = temp_BatteryVoltage2;
				legend_buckets = [3,4,5];
				break;
				
		  }
		  
		 select_index = Date_arr.length - 1;
		  if(select_list[select_index] <= legend_buckets[0]){
				marker_color = marker_color_list[0];
		  }
		  else if(select_list[select_index] > legend_buckets[0] && select_list[select_index] <= legend_buckets[1]){
				marker_color = marker_color_list[1];
		  }
		  else if(select_list[select_index] > legend_buckets[1] && select_list[select_index] <= legend_buckets[2]){
				marker_color = marker_color_list[2];
		  }
		  else if(select_list[select_index] > legend_buckets[2]){
				marker_color = marker_color_list[3];
		  }
		  
		  select_index = Date_arr2.length - 1;
		  if(select_list2[select_index] <= legend_buckets[0]){
				marker_color2 = marker_color_list[0];
		  }
		  else if(select_list2[select_index] > legend_buckets[0] && select_list2[select_index] <= legend_buckets[1]){
				marker_color2 = marker_color_list[1];
		  }
		  else if(select_list2[select_index] > legend_buckets[1] && select_list2[select_index] <= legend_buckets[2]){
				marker_color2 = marker_color_list[2];
		  }
		  else if(select_list2[select_index] > legend_buckets[2]){
				marker_color2 = marker_color_list[3];
		  }
		    var marker = L.circle([44.54916667, -123.21583333],{
		    color: marker_color,
			fillColor: marker_color,
			fillOpacity: 1,
			radius: 25
		  
		  }
		  ).addTo(map).bindPopup("Device 1 " + selection + " :" + select_list[select_index]);
		  
		  
		   var marker2 = L.circle([44.55111111, -123.21555556],{
		    color: marker_color2,
			fillColor: marker_color2,
			fillOpacity: 1,
			radius: 25
		  
		  }
		  ).addTo(map).bindPopup("Device 2 " + selection + " :" + select_list2[select_index]);;
	
		  




		
		  legend.onAdd = function() {
		  var div;
		  div = L.DomUtil.create('div', 'legend');
		  div.innerHTML = '';
		  //create a legend customized for the measurement selected by the user
		  switch(selection){
		    
			case "temperature":

				div.innerHTML += '<b>Temperature(C)</b><br />';
				div.innerHTML += '<i style="background: ' + marker_color_list[3] + '; opacity: 0.5"></i><p>30+</p>';
				div.innerHTML += '<i style="background: ' + marker_color_list[2] + '; opacity: 0.5"></i><p>20-30</p>';
				div.innerHTML += '<i style="background: ' + marker_color_list[1] + '; opacity: 0.5"></i><p>10-20</p>';
				div.innerHTML += '<i style="background: ' + marker_color_list[0] + '; opacity: 0.5"></i><p> 0-10</p>';
				break;
		  
			case "humidity":
				div.innerHTML += '<b>% Humidity</b><br />';
				div.innerHTML += '<i style="background: ' + marker_color_list[3] + '; opacity: 0.5"></i><p>70+</p>';
				div.innerHTML += '<i style="background: ' + marker_color_list[2] + '; opacity: 0.5"></i><p>50-70</p>';
				div.innerHTML += '<i style="background: ' + marker_color_list[1] + '; opacity: 0.5"></i><p>30-50</p>';
				div.innerHTML += '<i style="background: ' + marker_color_list[0] + '; opacity: 0.5"></i><p> 0-30</p>';
				break;
				
			case "loadcell":
				div.innerHTML += '<b>LoadCell</b><br />';
				div.innerHTML += '<i style="background: ' + marker_color_list[3] + '; opacity: 0.5"></i><p>0+</p>';
				div.innerHTML += '<i style="background: ' + marker_color_list[2] + '; opacity: 0.5"></i><p>-.5 - 0</p>';
				div.innerHTML += '<i style="background: ' + marker_color_list[1] + '; opacity: 0.5"></i><p>-1 - -0.5</p>';
				div.innerHTML += '<i style="background: ' + marker_color_list[0] + '; opacity: 0.5"></i><p><-1</p>';
				break;
				
			case "battery_voltage":
				div.innerHTML += '<b>Battery Voltage</b><br />';
				div.innerHTML += '<i style="background: ' + marker_color_list[3] + '; opacity: 0.5"></i><p>5+</p>';
				div.innerHTML += '<i style="background: ' + marker_color_list[2] + '; opacity: 0.5"></i><p>4-5</p>';
				div.innerHTML += '<i style="background: ' + marker_color_list[1] + '; opacity: 0.5"></i><p>3-4</p>';
				div.innerHTML += '<i style="background: ' + marker_color_list[0] + '; opacity: 0.5"></i><p><3</p>';
				break;
			/*case "elec_cond":
				div.innerHTML += '<b>Electric Conductivity</b><br />';
				div.innerHTML += '<i style="background: ' + marker_color_list[3] + '; opacity: 0.5"></i><p>250+</p>';
				div.innerHTML += '<i style="background: ' + marker_color_list[2] + '; opacity: 0.5"></i><p>225-250</p>';
				div.innerHTML += '<i style="background: ' + marker_color_list[1] + '; opacity: 0.5"></i><p>200-225</p>';
				div.innerHTML += '<i style="background: ' + marker_color_list[0] + '; opacity: 0.5"></i><p><200</p>';
				break;*/
			
			}
			return div;
			
		  };
		  legend.addTo(map);
		   });
		   };
		   $(document).ready(function(){
				create_geoviz_map();
				setInterval(create_geoviz_map,300000);
			});
		  
  </script>
</body>

</html>
